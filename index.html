<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Diagrama BowTie y FTA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        /* --- NUEVA PALETA DE COLORES CORPORATIVA Y SOBRIA --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f5; /* Fondo general gris muy claro */
        }
        /* Helpers JS movidos al <script> para evitar errores CSS */
        .corp-header {
            background-color: #ffffff;
            border-bottom: 4px solid #FFF159; /* Acento amarillo Mercado Libre */
        }
        .corp-title {
            color: #333333; /* Texto principal oscuro para alto contraste */
        }
        .corp-subtitle {
            color: #666666; /* Gris secundario para subtítulos */
        }
        .input-group {
            border: 1px solid #e5e7eb;
            border-left: 4px solid #d1d5db; /* Acento gris claro */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #ffffff;
        }
        .section-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 2px 8px rgba(0,0,0,0.05); /* Sombra sutil */
        }
        .section-title {
            color: #333333;
            font-weight: 600;
        }
        /* Botones de Acción Principales */
        .action-button {
            font-weight: 600;
            padding: 0.5rem 1.25rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border: 1px solid transparent;
        }
        .action-button-primary {
            background-color: #333333;
            color: #ffffff;
            border-color: #333333;
        }
        .action-button-primary:hover {
            background-color: #000000;
        }
        .action-button-secondary {
            background-color: #f3f4f6; /* Gris muy claro */
            color: #374151; /* Texto gris oscuro */
            border-color: #d1d5db; /* Borde gris */
        }
        .action-button-secondary:hover {
             background-color: #e5e7eb;
        }
        .action-button-danger {
            background-color: #ef4444;
            color: #ffffff;
        }
        .action-button-danger:hover {
             background-color: #dc2626;
        }

        /* Pestañas */
        .tab-button-active {
            border-color: #333333; 
            color: #333333;
            font-weight: 600;
        }
        .tab-button-inactive {
            border-color: transparent;
            color: #6b7280; 
        }
        .tab-button-inactive:hover {
            border-color: #d1d5db; 
            color: #333333; 
        }

        /* --- Estilos para los diagramas (sin cambios de color) --- */
        .diagram-box {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease-in-out;
        }
        .diagram-box:hover {
            transform: translateY(-2px);
        }
        .diagram-section-title {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .barrier-line {
            height: 2px;
            width: 10px; 
        }
        .preventive-barrier-line { background-color: #7dd3fc; }
        .mitigative-barrier-line { background-color: #fca5a5; }
        /* Indicador de efectividad de barreras */
        .eff-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 9999px;
            margin-right: 6px;
            vertical-align: middle;
            /* Halo para mejorar contraste en cualquier fondo */
            box-shadow: 0 0 0 2px rgba(255,255,255,0.85);
        }
        .eff-high { background-color: #16a34a; }   /* verde */
        .eff-medium { background-color: #f59e0b; } /* ámbar */
        .eff-low { background-color: #dc2626; }    /* rojo */
        /* Placeholder visual para DnD de barreras */
        .barrier-placeholder {
            border: 2px dashed #9ca3af;
            border-radius: 0.375rem;
            background-color: #f3f4f6;
            margin: 4px 0;
        }

        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-active {
            display: flex;
        }
        
        .fta-diagram-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 5px; 
            position: relative; 
        }
        .fta-event-box, .fta-gate-box {
            border: 1px solid #4b5563; 
            padding: 6px 10px;
            text-align: center;
            min-width: 130px; 
            max-width: 220px;
            background-color: #ffffff; 
            border-radius: 0.25rem;
            font-size: 0.75rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .fta-event-box .description {
            font-weight: 500;
            color: #111827; 
            margin-bottom: 2px; 
            min-height: 1.5em; 
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .fta-event-box .percentage {
            font-size: 0.7rem;
            color: #374151; 
            border-top: 1px solid #d1d5db; 
            margin-top: 4px;
            padding-top: 4px;
        }
        .fta-top-event-box { 
            background-color: #fef2f2; 
            border-color: #b91c1c; 
            font-size: 0.8rem; 
            border-width: 2px; 
        }
        .fta-intermediate-event-box {
            background-color: #fefce8; 
            border-color: #eab308; 
        }
        .fta-basic-event-box {
            background-color: #f0fdf4; 
            border-color: #16a34a; 
        }
        .fta-gate-box {
            margin-top: 8px;
            margin-bottom: 8px;
            font-weight: bold;
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        .fta-gate-or {
            background-color: #fdf2f8; 
            border-color: #db2777; 
            color: #9d174d; 
        }
        .fta-gate-and {
            background-color: #eef2ff; 
            border-color: #4f46e5; 
            color: #3730a3; 
        }
        .fta-node-children-container {
            display: flex;
            justify-content: center; 
            gap: 10px; 
            margin-top: 8px; 
            position: relative;
            padding-top: 15px; 
        }
        .fta-line-down { 
            position: absolute;
            bottom: -10px; 
            left: 50%;
            transform: translateX(-50%);
            width: 2px; 
            height: 10px; 
            background-color: #4b5563; 
        }
         .fta-line-up { 
            position: absolute;
            top: -10px; 
            left: 50%;
            transform: translateX(-50%);
            width: 2px; 
            height: 10px; 
            background-color: #4b5563; 
        }
        .fta-children-horizontal-bar {
            position: absolute;
            top: 0px; 
            height: 2px; 
            background-color: #4b5563; 
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-6 py-4 corp-header">
            <h1 class="text-3xl md:text-4xl font-bold corp-title">Análisis de Riesgos</h1>
            <p class="corp-subtitle mt-2">Herramienta para Diagramas BowTie y Árboles de Fallos</p>
        </header>

        <div class="flex flex-col sm:flex-row flex-wrap justify-center items-center space-y-3 sm:space-y-0 sm:space-x-3 mb-8 pb-4 border-b border-gray-200">
            <button id="generateBtn" onclick="generateCurrentDiagram()" class="action-button action-button-primary">
                Generar/Actualizar Diagrama
            </button>
            <button onclick="exportCurrentAnalysis()" class="action-button action-button-secondary">
                Exportar
            </button>
            <label for="importFile" class="action-button action-button-secondary cursor-pointer">
                Importar
            </label>
            <input type="file" id="importFile" class="hidden" accept=".xlsx, .xls" onchange="handleCurrentFileImport(event)">
            <button onclick="confirmCurrentReset()" class="action-button action-button-danger">
                Reiniciar Análisis
            </button>
        </div>

        <div class="mb-4 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="analysisTabs" role="tablist">
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg tab-button-active" id="bowtie-tab-button" type="button" role="tab" aria-controls="bowtieContent" aria-selected="true">Análisis BowTie</button>
                </li>
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg tab-button-inactive" id="fta-tab-button" type="button" role="tab" aria-controls="ftaContent" aria-selected="false">Análisis Árbol de Fallos (FTA)</button>
                </li>
            </ul>
        </div>

        <div id="tabContentContainer">
            <div id="bowtieContent" role="tabpanel" aria-labelledby="bowtie-tab-button">
                 <section class="mb-8 p-6 section-card">
                    <h2 class="text-2xl font-semibold mb-6 section-title border-b pb-2">1. Definición del Riesgo (BowTie)</h2>
                    <div class="mb-6">
                        <label for="riskEvent" class="block text-lg font-medium text-gray-700 mb-2">Evento Central de Riesgo:</label>
                        <input type="text" id="riskEvent" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Robo de Mercadería">
                    </div>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">2. Causas y Barreras Preventivas</h3>
                            <div id="causesContainer" class="space-y-4"></div>
                            <button onclick="addCauseInput()" class="mt-4 action-button action-button-secondary">
                                + Añadir Causa
                            </button>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">3. Consecuencias y Barreras Mitigantes</h3>
                            <div id="impactsContainer" class="space-y-4"></div>
                            <button onclick="addImpactInput()" class="mt-4 action-button action-button-secondary">
                                + Añadir Consecuencia
                            </button>
                        </div>
                    </div>
                </section>
                <section id="bowtieDiagramVisualization" class="mt-12 p-4 md:p-6 section-card min-h-[400px]">
                    <div class="grid grid-cols-3 items-center mb-6 border-b pb-2">
                        <div class="hidden sm:flex items-center gap-3 text-xs text-gray-600" aria-label="Leyenda de efectividad de barreras">
                            <span class="mr-2 font-medium text-gray-700">Efectividad de la barrera:</span>
                            <span class="flex items-center"><span class="eff-dot eff-high" aria-hidden="true"></span>Alta</span>
                            <span class="flex items-center"><span class="eff-dot eff-medium" aria-hidden="true"></span>Media</span>
                            <span class="flex items-center"><span class="eff-dot eff-low" aria-hidden="true"></span>Baja</span>
                        </div>
                        <h2 class="text-2xl font-semibold text-center section-title">Diagrama Bow-Tie</h2>
                        <div class="text-right">
                            <button type="button" data-export-ignore="true" onclick="exportBowtieDiagramImage()" class="action-button action-button-secondary">
                                Exportar imagen
                            </button>
                        </div>
                    </div>
                    <div id="bowtieDiagram" class="flex flex-col md:flex-row justify-between items-stretch w-full p-2 md:p-4 min-h-[300px] gap-2 md:gap-4">
                        <div id="threatsSide" class="w-full md:w-2/5 flex flex-col items-center p-3 md:p-4 bg-sky-600 rounded-xl text-white diagram-box">
                            <h3 class="text-xl md:text-2xl font-bold mb-4 diagram-section-title">CAUSAS</h3>
                            <div id="causesContainerForDiagram" class="space-y-2 w-full flex flex-col items-center"></div>
                        </div>
                        <div id="eventSide" class="w-full md:w-1/5 flex flex-col items-center justify-center p-2 md:p-4 my-4 md:my-0">
                            <div id="eventBoxDiagram" class="bg-[#FFF159] text-gray-900 border border-yellow-300 p-4 md:p-6 rounded-xl text-center font-bold text-lg md:text-xl shadow-xl min-h-[80px] flex items-center justify-center diagram-box">
                                EVENTO
                            </div>
                        </div>
                        <div id="consequencesSide" class="w-full md:w-2/5 flex flex-col items-center p-3 md:p-4 bg-rose-600 rounded-xl text-white diagram-box">
                            <h3 class="text-xl md:text-2xl font-bold mb-4 diagram-section-title">CONSECUENCIAS</h3>
                            <div id="impactsContainerForDiagram" class="space-y-2 w-full flex flex-col items-center"></div>
                        </div>
                    </div>
                </section>
            </div>

            <div id="ftaContent" role="tabpanel" aria-labelledby="fta-tab-button" class="hidden">
                <section class="mb-8 p-6 section-card">
                    <h2 class="text-2xl font-semibold mb-6 section-title border-b pb-2">1. Definición del Árbol de Fallos (FTA)</h2>
                    <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">Evento Principal (Top Event)</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                            <div>
                                <label for="ftaTopEventDesc" class="block text-sm font-medium text-gray-700">Descripción:</label>
                                <input type="text" id="ftaTopEventDesc" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Descripción del evento principal">
                            </div>
                            <div>
                                <label for="ftaTopEventProb" class="block text-sm font-medium text-gray-700">Probabilidad (%):</label>
                                <input type="number" id="ftaTopEventProb" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm bg-gray-200" placeholder="Calculada" readonly>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="ftaTopEventGate" class="block text-sm font-medium text-gray-700">Compuerta (debajo del Top Event):</label>
                                <select id="ftaTopEventGate" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="OR">OR</option>
                                    <option value="AND">AND</option>
                                </select>
                            </div>
                            <div>
                                <label for="ftaTopEventInputs" class="block text-sm font-medium text-gray-700">IDs de Entradas a esta Compuerta (Ej: N1, N2):</label>
                                <input type="text" id="ftaTopEventInputs" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="N1, N2, ...">
                            </div>
                        </div>
                         <div class="mt-3 text-right">
                            <button onclick="addFtaChildElement('ftaTopEventInputs')" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-2 rounded-md">
                                + Añadir Entrada a Compuerta del Top Event
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">2. Elementos del Árbol (Intermedios y Base)</h3>
                        <div id="ftaElementsContainer" class="space-y-4">
                        </div>
                        <!-- Botón general de añadir elemento eliminado -->
                    </div>
                </section>
                <section id="ftaDiagramVisualization" class="mt-12 p-4 md:p-6 section-card min-h-[300px]">
                    <h2 class="text-2xl font-semibold mb-6 text-center section-title border-b pb-2">Diagrama del Árbol de Fallos (FTA)</h2>
                    <div id="ftaDiagramContainer" class="text-sm text-gray-700 p-4 border rounded-lg bg-gray-50 min-h-[200px] overflow-x-auto flex flex-col items-center">
                        <p class="text-gray-400">El diagrama del FTA aparecerá aquí después de generar.</p>
                    </div>
                </section>
            </div>
        </div>


        <footer class="text-center mt-12 py-6 border-t border-gray-200"></footer>
    </div>

    <div id="resetConfirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full justify-center items-center hidden z-50 modal">
        <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-11/12 max-w-md mx-auto">
            <h3 id="resetModalTitle" class="text-xl md:text-2xl font-bold mb-4 text-gray-700">Confirmar Reinicio</h3>
            <p id="resetModalMessage" class="text-gray-600 mb-6">¿Estás seguro de que deseas borrar todos los datos ingresados? Esta acción no se puede deshacer.</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeResetModal()" class="action-button action-button-secondary">
                    Cancelar
                </button>
                <button id="confirmResetButton" class="action-button action-button-danger">
                    Sí, Reiniciar
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Gestión de Pestañas ---
        const tabButtons = {
            bowtie: document.getElementById('bowtie-tab-button'),
            fta: document.getElementById('fta-tab-button')
        };
        const tabContents = {
            bowtie: document.getElementById('bowtieContent'),
            fta: document.getElementById('ftaContent')
        };
        let activeTab = 'bowtie'; 

        function showTab(tabId) {
            activeTab = tabId;
            for (const id in tabContents) {
                if (id === tabId) {
                    tabContents[id].classList.remove('hidden');
                    tabButtons[id].classList.add('tab-button-active');
                    tabButtons[id].classList.remove('tab-button-inactive');
                    tabButtons[id].setAttribute('aria-selected', 'true');
                } else {
                    tabContents[id].classList.add('hidden');
                    tabButtons[id].classList.remove('tab-button-active');
                    tabButtons[id].classList.add('tab-button-inactive');
                    tabButtons[id].setAttribute('aria-selected', 'false');
                }
            }
            // Ocultar botón de generar en BowTie, mostrar en FTA
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                if (tabId === 'bowtie') generateBtn.classList.add('hidden');
                else generateBtn.classList.remove('hidden');
            }
        }
        tabButtons.bowtie.addEventListener('click', () => showTab('bowtie'));
        tabButtons.fta.addEventListener('click', () => showTab('fta'));
        showTab('bowtie'); 
        // Habilitar DnD en contenedores de barreras existentes al inicio
        function enableDndForAllBarrierContainers() {
            document.querySelectorAll('.preventive-barriers-container, .mitigative-barriers-container')
                .forEach(c => enableDnDForContainer(c, '.barrier-input-item'));
        }
        enableDndForAllBarrierContainers();

        let causeCounter = 0;
        let impactCounter = 0;
        let ftaNodeCounter = 0;

        // --- Auto-actualización del diagrama BowTie con debounce ---
        function debounce(fn, delay = 300) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(null, args), delay);
            };
        }
        const debouncedRenderBowTie = debounce(() => {
            if (activeTab === 'bowtie') {
                renderBowTieDiagram(false); // no desplazar al diagrama durante auto-actualización
            }
        }, 300);
        // Entradas que deben refrescar el diagrama al escribir
        document.getElementById('riskEvent').addEventListener('input', debouncedRenderBowTie);
        document.getElementById('causesContainer').addEventListener('input', debouncedRenderBowTie, true);
        document.getElementById('impactsContainer').addEventListener('input', debouncedRenderBowTie, true);
        // también refrescar cuando cambie la efectividad (select)
        document.getElementById('causesContainer').addEventListener('change', debouncedRenderBowTie, true);
        document.getElementById('impactsContainer').addEventListener('change', debouncedRenderBowTie, true);

        // --- Reordenación por arrastrar y soltar (HTML5 DnD) ---
        let bowtieDrag = { el: null, type: null, placeholder: null, container: null };
        let dndIdCounter = 0;
        function getOrAssignDndId(el) {
            if (!el) return '';
            if (!el.dataset.dndId) el.dataset.dndId = `dnd-${++dndIdCounter}`;
            return el.dataset.dndId;
        }
        function enableDnDForContainer(container, itemSelector, typeKey) {
            const containerEl = typeof container === 'string' ? document.querySelector(container) : container;
            if (!containerEl) return;
            const dndType = typeKey || getOrAssignDndId(containerEl);

            if (!containerEl.dataset.dndBound) {
                containerEl.addEventListener('dragenter', (e) => {
                    if (bowtieDrag.el && bowtieDrag.type === dndType) {
                        e.preventDefault();
                    }
                });
                containerEl.addEventListener('dragover', (e) => {
                    if (bowtieDrag.el && bowtieDrag.type === dndType) {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        // Para barreras, mover el placeholder (no el elemento oculto)
                        if (itemSelector === '.barrier-input-item' && bowtieDrag.placeholder) {
                            const y = e.clientY;
                            const items = Array.from(containerEl.querySelectorAll(itemSelector))
                                               .filter(n => n !== bowtieDrag.el && n !== bowtieDrag.placeholder);
                            let beforeNode = null; let maxNeg = -Infinity;
                            for (const n of items) {
                                const rect = n.getBoundingClientRect();
                                const offset = y - (rect.top + rect.height / 2);
                                if (offset < 0 && offset > maxNeg) { maxNeg = offset; beforeNode = n; }
                            }
                            if (beforeNode) containerEl.insertBefore(bowtieDrag.placeholder, beforeNode);
                            else containerEl.appendChild(bowtieDrag.placeholder);
                        }
                    }
                });
                containerEl.addEventListener('drop', (e) => {
                    if (bowtieDrag.el && bowtieDrag.type === dndType) {
                        e.preventDefault();
                        // Finalizar DnD de barreras usando el placeholder
                        if (itemSelector === '.barrier-input-item' && bowtieDrag.placeholder) {
                            try {
                                containerEl.insertBefore(bowtieDrag.el, bowtieDrag.placeholder);
                            } catch(_) {}
                            bowtieDrag.el.style.display = '';
                            bowtieDrag.placeholder.remove();
                            bowtieDrag.placeholder = null;
                            bowtieDrag.container = null;
                        }
                        debouncedRenderBowTie();
                    }
                });
                containerEl.dataset.dndBound = '1';
            }

            containerEl.querySelectorAll(itemSelector).forEach((item) => {
                if (item.dataset.dndItemBound === '1') return;
                // Para barreras, arrastre desde toda la fila (sin asa); para otras, también la fila
                let dragStarterEl = item;
                if (item.classList.contains('barrier-input-item')) {
                    // Toda la fila es arrastrable (sin asa)
                    item.draggable = true;
                }
                dragStarterEl.draggable = true;
                dragStarterEl.addEventListener('dragstart', (e) => {
                    bowtieDrag.el = item;
                    bowtieDrag.type = dndType;
                    bowtieDrag.container = containerEl;
                    e.dataTransfer.effectAllowed = 'move';
                    try { e.dataTransfer.setData('text/plain', 'move'); } catch (_) {}
                    item.classList.add('opacity-50', 'dragging');
                    // Crear placeholder visual para barreras
                    if (item.classList.contains('barrier-input-item') && !bowtieDrag.placeholder) {
                        const rect = item.getBoundingClientRect();
                        const ph = document.createElement('div');
                        ph.className = 'barrier-placeholder';
                        ph.style.height = rect.height + 'px';
                        try { containerEl.insertBefore(ph, item.nextSibling); } catch(_) {}
                        bowtieDrag.placeholder = ph;
                        // Ocultar el item original para que el placeholder represente su lugar
                        item.style.display = 'none';
                    }
                });
                dragStarterEl.addEventListener('dragend', () => {
                    item.classList.remove('opacity-50', 'dragging');
                    // Si se canceló fuera de drop, restaurar
                    if (item.classList.contains('barrier-input-item') && bowtieDrag.placeholder && bowtieDrag.container) {
                        try { bowtieDrag.container.insertBefore(item, bowtieDrag.placeholder); } catch(_) {}
                        item.style.display = '';
                        bowtieDrag.placeholder.remove();
                    }
                    bowtieDrag.placeholder = null;
                    bowtieDrag.container = null;
                    bowtieDrag.el = null;
                });
                // Reordenamiento por fila para causas y consecuencias (no barreras)
                if (itemSelector !== '.barrier-input-item') {
                    item.addEventListener('dragover', (e) => {
                        if (bowtieDrag.el && bowtieDrag.type === dndType) {
                            e.preventDefault();
                            const rect = item.getBoundingClientRect();
                            const offset = e.clientY - (rect.top + rect.height / 2);
                            const parent = item.parentNode;
                            if (offset < 0) parent.insertBefore(bowtieDrag.el, item);
                            else parent.insertBefore(bowtieDrag.el, item.nextSibling);
                        }
                    });
                }
                item.addEventListener('drop', (e) => {
                    if (bowtieDrag.el && bowtieDrag.type === dndType) {
                        e.preventDefault();
                        // Finalizar también aquí para el caso de barreras cuando el drop cae sobre un item
                        if (itemSelector === '.barrier-input-item' && bowtieDrag.placeholder && bowtieDrag.container) {
                            try { bowtieDrag.container.insertBefore(bowtieDrag.el, bowtieDrag.placeholder); } catch(_) {}
                            bowtieDrag.el.style.display = '';
                            bowtieDrag.placeholder.remove();
                            bowtieDrag.placeholder = null;
                            bowtieDrag.container = null;
                        }
                        debouncedRenderBowTie();
                    }
                });
                item.dataset.dndItemBound = '1';
            });
        }

        function validatePercentageInput(inputElement) {
            let value = parseInt(inputElement.value);
            if (isNaN(value) && inputElement.value !== "") { 
                inputElement.value = '';
            } else if (value < 0 && inputElement.value !== "") { 
                 inputElement.value = 0;
            } else if (value > 100) {
                inputElement.value = 100;
            }
            if (inputElement.value !== "" && !isNaN(value)) {
                 inputElement.value = value; 
            }
        }


        function addCauseInput() {
            causeCounter++;
            const causeId = `cause-${causeCounter}`;
            const container = document.getElementById('causesContainer');
            const div = document.createElement('div');
            div.className = 'input-group cause-input-group';
            div.id = causeId;
            const removeElementHandler = `removeElement('${causeId}')`;
            const addPreventiveBarrierHandler = `addPreventiveBarrierInput('${causeId}')`;
            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-md font-medium text-gray-700">Causa ${causeCounter}:</label>
                    <button onclick="${removeElementHandler}" class="inline-flex items-center justify-center p-1 text-red-500 hover:text-red-700" aria-label="Eliminar causa" title="Eliminar causa">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4" aria-hidden="true">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2h.293l.853 10.24A2 2 0 007.138 18h5.724a2 2 0 001.992-1.76L15.707 6H16a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0010 2H9zm-1 6a1 1 0 112 0v7a1 1 0 11-2 0V8zm4 0a1 1 0 112 0v7a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <input type="text" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 cause-name-input" placeholder="Nombre de la causa">
                <div class="mt-3">
                    <h4 class="text-sm font-medium text-gray-600 mb-1">Barreras Preventivas:</h4>
                    <div class="preventive-barriers-container space-y-2"></div>
                    <button onclick="${addPreventiveBarrierHandler}" class="mt-2 text-xs bg-sky-200 hover:bg-sky-300 text-sky-800 font-semibold py-1 px-2 rounded-md">
                        + Añadir Barrera Preventiva
                    </button>
                </div>
            `;
            container.appendChild(div);
            if (typeof debouncedRenderBowTie === 'function') debouncedRenderBowTie();
            // habilitar DnD para causas
            enableDnDForContainer(container, '.cause-input-group');
            // foco automático en el nombre de la causa
            const nameInput = div.querySelector('.cause-name-input');
            if (nameInput) { try { nameInput.focus(); nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (_) {} }
            return div;
        }

        function addPreventiveBarrierInput(causeId) {
            const causeElement = document.getElementById(causeId);
            if (!causeElement) { console.error("Elemento Causa no encontrado:", causeId); return null; }
            const barriersContainer = causeElement.querySelector('.preventive-barriers-container');
            if (!barriersContainer) { console.error("Contenedor de Barreras Preventivas no encontrado en:", causeId); return null; }
            const barrierDiv = document.createElement('div');
            barrierDiv.className = 'flex items-center space-x-2 barrier-input-item';
            barrierDiv.innerHTML = `
                <div class="flex items-center gap-1">
                  <button type="button" class="p-1 text-gray-400 hover:text-gray-600" aria-label="Mover arriba" title="Mover arriba" onclick="moveBarrier(this.closest('.barrier-input-item'), 'up')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M3 10l7-7 7 7H3z"/></svg>
                  </button>
                  <button type="button" class="p-1 text-gray-400 hover:text-gray-600" aria-label="Mover abajo" title="Mover abajo" onclick="moveBarrier(this.closest('.barrier-input-item'), 'down')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M17 10l-7 7-7-7h14z"/></svg>
                  </button>
                </div>
                <input type="text" class="w-full p-1 border border-gray-300 rounded-md text-sm preventive-barrier-input" placeholder="Descripción de la barrera">
                <select class="barrier-effectiveness text-xs border border-gray-300 rounded-md p-1 ml-1" title="Efectividad">
                    <option value="high">Alta</option>
                    <option value="medium" selected>Media</option>
                    <option value="low">Baja</option>
                </select>
                <button onclick="removeElement(this.parentElement)" class="inline-flex items-center justify-center p-1 text-red-500 hover:text-red-700" aria-label="Eliminar barrera" title="Eliminar barrera">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4" aria-hidden="true">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2h.293l.853 10.24A2 2 0 007.138 18h5.724a2 2 0 001.992-1.76L15.707 6H16a 1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0010 2H9zm-1 6a1 1 0 112 0v7a1 1 0 11-2 0V8zm4 0a1 1 0 112 0v7a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            barriersContainer.appendChild(barrierDiv);
            if (typeof debouncedRenderBowTie === 'function') debouncedRenderBowTie();
            // habilitar DnD para barreras preventivas dentro de esta causa
            enableDnDForContainer(barriersContainer, '.barrier-input-item');
            const inputEl = barrierDiv.querySelector('.preventive-barrier-input');
            if (inputEl) { try { inputEl.focus(); inputEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (_) {} }
            return inputEl;
        }

        function addImpactInput() {
            impactCounter++;
            const impactId = `impact-${impactCounter}`;
            const container = document.getElementById('impactsContainer');
            const div = document.createElement('div');
            div.className = 'input-group impact-input-group';
            div.id = impactId;
            const removeElementHandler = `removeElement('${impactId}')`;
            const addMitigativeBarrierHandler = `addMitigativeBarrierInput('${impactId}')`;
            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-md font-medium text-gray-700">Consecuencia ${impactCounter}:</label>
                    <button onclick="${removeElementHandler}" class="inline-flex items-center justify-center p-1 text-red-500 hover:text-red-700" aria-label="Eliminar consecuencia" title="Eliminar consecuencia">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4" aria-hidden="true">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2h.293l.853 10.24A2 2 0 007.138 18h5.724a2 2 0 001.992-1.76L15.707 6H16a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0010 2H9zm-1 6a1 1 0 112 0v7a1 1 0 11-2 0V8zm4 0a1 1 0 112 0v7a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <input type="text" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 impact-name-input" placeholder="Nombre de la Consecuencia">
                <div class="mt-3">
                    <h4 class="text-sm font-medium text-gray-600 mb-1">Barreras Mitigantes:</h4>
                    <div class="mitigative-barriers-container space-y-2"></div>
                    <button onclick="${addMitigativeBarrierHandler}" class="mt-2 text-xs bg-rose-200 hover:bg-rose-300 text-rose-800 font-semibold py-1 px-2 rounded-md">
                        + Añadir Barrera Mitigante
                    </button>
                </div>
            `;
            container.appendChild(div);
            if (typeof debouncedRenderBowTie === 'function') debouncedRenderBowTie();
            // habilitar DnD para consecuencias
            enableDnDForContainer(container, '.impact-input-group');
            // foco automático en el nombre de la consecuencia
            const nameInput = div.querySelector('.impact-name-input');
            if (nameInput) { try { nameInput.focus(); nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (_) {} }
            return div;
        }

        function addMitigativeBarrierInput(impactId) {
            const impactElement = document.getElementById(impactId);
            if (!impactElement) { console.error("Elemento Consecuencia no encontrada:", impactId); return null; }
            const barriersContainer = impactElement.querySelector('.mitigative-barriers-container');
            if (!barriersContainer) { console.error("Contenedor de Barreras Mitigantes no encontrado en:", impactId); return null; }
            const barrierDiv = document.createElement('div');
            barrierDiv.className = 'flex items-center space-x-2 barrier-input-item';
            barrierDiv.innerHTML = `
                <div class="flex items-center gap-1">
                  <button type="button" class="p-1 text-gray-400 hover:text-gray-600" aria-label="Mover arriba" title="Mover arriba" onclick="moveBarrier(this.closest('.barrier-input-item'), 'up')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M3 10l7-7 7 7H3z"/></svg>
                  </button>
                  <button type="button" class="p-1 text-gray-400 hover:text-gray-600" aria-label="Mover abajo" title="Mover abajo" onclick="moveBarrier(this.closest('.barrier-input-item'), 'down')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M17 10l-7 7-7-7h14z"/></svg>
                  </button>
                </div>
                <input type="text" class="w-full p-1 border border-gray-300 rounded-md text-sm mitigative-barrier-input" placeholder="Descripción de la barrera">
                <select class="barrier-effectiveness text-xs border border-gray-300 rounded-md p-1 ml-1" title="Efectividad">
                    <option value="high">Alta</option>
                    <option value="medium" selected>Media</option>
                    <option value="low">Baja</option>
                </select>
                <button onclick="removeElement(this.parentElement)" class="inline-flex items-center justify-center p-1 text-red-500 hover:text-red-700" aria-label="Eliminar barrera" title="Eliminar barrera">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4" aria-hidden="true">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2h.293l.853 10.24A2 2 0 007.138 18h5.724a2 2 0 001.992-1.76L15.707 6H16a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0010 2H9zm-1 6a1 1 0 112 0v7a1 1 0 11-2 0V8zm4 0a1 1 0 112 0v7a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            barriersContainer.appendChild(barrierDiv);
            if (typeof debouncedRenderBowTie === 'function') debouncedRenderBowTie();
            // habilitar DnD para barreras mitigantes dentro de esta consecuencia
            enableDnDForContainer(barriersContainer, '.barrier-input-item');
            const inputEl = barrierDiv.querySelector('.mitigative-barrier-input');
            if (inputEl) { try { inputEl.focus(); inputEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (_) {} }
            return inputEl;
        }

        function removeElement(elementOrId) {
            const element = typeof elementOrId === 'string' ? document.getElementById(elementOrId) : elementOrId;
            if (element) { element.remove(); }
            if (typeof debouncedRenderBowTie === 'function') debouncedRenderBowTie();
        }

        function renderBowTieDiagram(scrollIntoView = true) {
            const riskEventName = document.getElementById('riskEvent').value || "EVENTO CENTRAL";
            document.getElementById('eventBoxDiagram').textContent = riskEventName;
            const causesContainerDiagram = document.getElementById('causesContainerForDiagram');
            const impactsContainerDiagram = document.getElementById('impactsContainerForDiagram');
            causesContainerDiagram.innerHTML = ''; 
            impactsContainerDiagram.innerHTML = ''; 

            document.querySelectorAll('.cause-input-group').forEach(group => {
                const causeName = group.querySelector('.cause-name-input').value || "Causa";
                const causeRefId = group.id;
                const preventiveItems = Array.from(group.querySelectorAll('.barrier-input-item'));
                const preventiveBarriers = preventiveItems.map(it => {
                    const txt = (it.querySelector('.preventive-barrier-input')?.value || '').trim();
                    const eff = it.querySelector('.barrier-effectiveness')?.value || 'medium';
                    return { text: txt, eff };
                }).filter(b => b.text !== "");
                const causeDiagramItem = document.createElement('div');
                causeDiagramItem.className = 'cause-item flex flex-col md:flex-row items-center justify-start w-full p-1 gap-1 md:gap-2'; 
                let barriersHTML = preventiveBarriers.length > 0 ? preventiveBarriers.map((b, idx) => {
                    const effClass = b.eff === 'high' ? 'eff-high' : (b.eff === 'low' ? 'eff-low' : 'eff-medium');
                    const effLabel = b.eff === 'high' ? 'Alta' : (b.eff === 'low' ? 'Baja' : 'Media');
                    return `<div class="flex items-center justify-end w-full">
                        <div class="barrier-box bg-sky-50 text-sky-900 border border-sky-200 hover:bg-sky-100 p-1.5 rounded-md text-xs shadow-sm diagram-box flex-1 text-left cursor-pointer transition transform duration-150 ease-out hover:shadow-sm hover:-translate-y-px hover:ring-1 hover:ring-sky-200" onclick="focusBowtieBarrier('${causeRefId}', 'preventive', ${idx})"><span class=\"eff-dot ${effClass}\" title=\"Efectividad: ${effLabel}\"></span>${b.text}</div>
                        <div class="barrier-line preventive-barrier-line ml-1"></div>
                    </div>`;
                }).join('<div class="h-1"></div>') : '<div class="text-xs text-sky-200 italic text-center w-full">Sin barreras</div>';
                causeDiagramItem.innerHTML = `
                    <div class="cause-box bg-sky-400 p-2 rounded-lg shadow-sm text-center diagram-box w-full md:w-1/2 order-1 cursor-pointer transition duration-150 ease-out transform hover:shadow-sm hover:-translate-y-px" onclick="focusBowtieGroup('${causeRefId}')">${causeName}</div>
                    <div class="preventive-barriers-diagram-list flex flex-col space-y-0.5 w-full md:w-1/2 order-2 items-stretch">
                        ${barriersHTML}
                    </div>`;
                causesContainerDiagram.appendChild(causeDiagramItem);
            });

            document.querySelectorAll('.impact-input-group').forEach(group => {
                const impactName = group.querySelector('.impact-name-input').value || "Consecuencia";
                const impactRefId = group.id;
                const mitigativeItems = Array.from(group.querySelectorAll('.barrier-input-item'));
                const mitigativeBarriers = mitigativeItems.map(it => {
                    const txt = (it.querySelector('.mitigative-barrier-input')?.value || '').trim();
                    const eff = it.querySelector('.barrier-effectiveness')?.value || 'medium';
                    return { text: txt, eff };
                }).filter(b => b.text !== "");
                const impactDiagramItem = document.createElement('div');
                impactDiagramItem.className = 'impact-item flex flex-col md:flex-row items-center justify-end w-full p-1 gap-1 md:gap-2';
                let barriersHTML = mitigativeBarriers.length > 0 ? mitigativeBarriers.map((b, idx) => {
                    const effClass = b.eff === 'high' ? 'eff-high' : (b.eff === 'low' ? 'eff-low' : 'eff-medium');
                    const effLabel = b.eff === 'high' ? 'Alta' : (b.eff === 'low' ? 'Baja' : 'Media');
                    return `<div class="flex items-center justify-start w-full">
                        <div class="barrier-line mitigative-barrier-line mr-1"></div>
                        <div class="barrier-box bg-rose-50 text-rose-900 border border-rose-200 hover:bg-rose-100 p-1.5 rounded-md text-xs shadow diagram-box flex-1 text-left cursor-pointer transition transform duration-150 ease-out hover:shadow-sm hover:-translate-y-px hover:ring-1 hover:ring-rose-200" onclick="focusBowtieBarrier('${impactRefId}', 'mitigative', ${idx})"><span class=\"eff-dot ${effClass}\" title=\"Efectividad: ${effLabel}\"></span>${b.text}</div>
                    </div>`;
                }).join('<div class="h-1"></div>') : '<div class="text-xs text-rose-200 italic text-center w-full">Sin barreras</div>';
                impactDiagramItem.innerHTML = `
                    <div class="mitigative-barriers-diagram-list flex flex-col space-y-0.5 w-full md:w-1/2 order-1 items-stretch">
                        ${barriersHTML}
                    </div>
                    <div class="impact-box bg-rose-400 p-2 rounded-lg shadow-md text-center diagram-box w-full md:w-1/2 order-2 cursor-pointer transition duration-150 ease-out transform hover:shadow-md hover:-translate-y-px" onclick="focusBowtieGroup('${impactRefId}')">${impactName}</div>`;
                impactsContainerDiagram.appendChild(impactDiagramItem);
            });
            if (scrollIntoView && document.getElementById('bowtieDiagramVisualization')) {
                 document.getElementById('bowtieDiagramVisualization').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // --- Edición desde el diagrama: helpers para enfocar campos originales ---
        function focusInputAndFlash(el) {
            if (!el) return;
            try { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (_) {}
            try { el.focus({ preventScroll: true }); } catch (_) { try { el.focus(); } catch (_) {} }
            const prev = el.className;
            el.className = (prev + ' ring-2 ring-yellow-400 transition').trim();
            setTimeout(() => { el.className = prev; }, 900);
        }
        function focusBowtieGroup(groupId) {
            const group = document.getElementById(groupId);
            if (!group) return;
            let target = null;
            if (group.classList.contains('cause-input-group')) {
                target = group.querySelector('.cause-name-input');
            } else if (group.classList.contains('impact-input-group')) {
                target = group.querySelector('.impact-name-input');
            }
            if (!target) {
                // Fallback: cualquier input de texto, evitando botones
                target = group.querySelector('input, textarea, select');
            }
            focusInputAndFlash(target || group);
        }
        function focusBowtieBarrier(groupId, barrierType, index) {
            const group = document.getElementById(groupId);
            if (!group) return;
            const selector = barrierType === 'preventive' ? '.preventive-barrier-input' : '.mitigative-barrier-input';
            const inputs = group.querySelectorAll(selector);
            const target = inputs && inputs[index] ? inputs[index] : null;
            focusInputAndFlash(target);
        }

        // Fallback: botones subir/bajar en barreras
        function moveBarrier(barrierEl, dir) {
            if (!barrierEl) return;
            const parent = barrierEl.parentElement;
            if (!parent) return;
            if (dir === 'up') {
                const prev = barrierEl.previousElementSibling;
                if (prev) parent.insertBefore(barrierEl, prev);
            } else {
                const next = barrierEl.nextElementSibling;
                if (next) parent.insertBefore(next, barrierEl);
            }
            debouncedRenderBowTie();
        }
        
        function exportBowtieDiagramImage() {
            const node = document.getElementById('bowtieDiagramVisualization');
            if (!node) return;

            const prevBg = node.style.backgroundColor;
            node.style.backgroundColor = '#ffffff';

            const scale = Math.max(window.devicePixelRatio || 1, 2) * 1.5;

            html2canvas(node, {
                backgroundColor: '#ffffff',
                scale,
                useCORS: true,
                ignoreElements: (el) => el.dataset && el.dataset.exportIgnore === 'true'
            }).then(canvas => {
                const link = document.createElement('a');
                const eventName = (document.getElementById('riskEvent')?.value || 'bowtie').trim()
                    .toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');
                link.download = `${eventName || 'bowtie'}_diagram.png`;
                canvas.toBlob((blob) => {
                    if (!blob) return;
                    link.href = URL.createObjectURL(blob);
                    link.click();
                    setTimeout(() => URL.revokeObjectURL(link.href), 2000);
                });
            }).finally(() => {
                node.style.backgroundColor = prevBg || '';
            });
        }
        
        function addFtaChildElement(parentInputsFieldId) {
            const newElementFullId = addFtaElementInput(); 
            if (newElementFullId) {
                const newElementShortId = `N${newElementFullId.split('-')[2]}`;
                const parentInputsField = document.getElementById(parentInputsFieldId);
                if (parentInputsField) {
                    parentInputsField.value = parentInputsField.value ? `${parentInputsField.value.trim()}, ${newElementShortId}`.replace(/^,|, $/, '') : newElementShortId;
                    const newElementDiv = document.getElementById(newElementFullId);
                    if (newElementDiv) {
                        newElementDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        const firstInput = newElementDiv.querySelector('input, select');
                        if (firstInput) firstInput.focus();
                    }
                }
            }
        }


        function addFtaElementInput() { 
            ftaNodeCounter++;
            const shortId = `N${ftaNodeCounter}`; 
            const fullId = `fta-node-${ftaNodeCounter}`; 
            const container = document.getElementById('ftaElementsContainer');
            const div = document.createElement('div');
            div.className = 'input-group fta-element-input-group';
            div.id = fullId; 
            
            let addButtonHTML = '';
            const addChildButtonId = `${fullId}-add-child-btn`;
            addButtonHTML = `
                <div id="${fullId}-add-child-section" class="mt-2 text-right hidden">
                     <button id="${addChildButtonId}" onclick="addFtaChildElement('${fullId}-inputs')" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-2 rounded-md">
                        + Añadir Entrada a esta Compuerta
                    </button>
                </div>`;

            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-md font-medium text-gray-700">Elemento ID: <span class="font-mono bg-indigo-100 text-indigo-700 px-1 rounded">${shortId}</span></label>
                    <button onclick="removeElement('${fullId}')" class="text-red-500 hover:text-red-700 font-semibold text-sm">Eliminar Elemento</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="${fullId}-desc" class="block text-sm font-medium text-gray-700">Descripción:</label>
                        <input type="text" id="${fullId}-desc" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm fta-element-desc" placeholder="Descripción del evento">
                    </div>
                    <div>
                        <label for="${fullId}-type" class="block text-sm font-medium text-gray-700">Tipo de Evento:</label>
                        <select id="${fullId}-type" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm fta-element-type" onchange="toggleFtaGateInput('${fullId}')">
                            <option value="BASIC">Evento Base</option>
                            <option value="INTERMEDIATE">Evento Intermedio</option>
                        </select>
                    </div>
                </div>
                <div id="${fullId}-prob-section" class="mt-3"> 
                     <label for="${fullId}-prob" class="block text-sm font-medium text-gray-700">Probabilidad (%):</label>
                     <input type="number" id="${fullId}-prob" min="0" max="100" oninput="validatePercentageInput(this)" class="w-full md:w-1/2 mt-1 p-2 border border-gray-300 rounded-md shadow-sm fta-element-prob" placeholder="0-100 (solo para Base)">
                </div>
                <div id="${fullId}-gate-section" class="hidden mt-3">
                    <label for="${fullId}-gate" class="block text-sm font-medium text-gray-700">Compuerta (debajo de este Intermedio):</label>
                    <select id="${fullId}-gate" class="w-full md:w-1/2 mt-1 p-2 border border-gray-300 rounded-md shadow-sm fta-element-gate">
                        <option value="OR">OR</option>
                        <option value="AND">AND</option>
                    </select>
                </div>
                <div id="${fullId}-inputs-section" class="hidden mt-3">
                    <label for="${fullId}-inputs" class="block text-sm font-medium text-gray-700">IDs de Entradas (Ej: N1, N2):</label>
                    <input type="text" id="${fullId}-inputs" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm fta-element-inputs" placeholder="N1, N2, ...">
                    ${addButtonHTML}
                </div>
            `;
            container.appendChild(div);
            toggleFtaGateInput(fullId); 
            return fullId; 
        }

        function toggleFtaGateInput(fullId) { 
            const typeSelect = document.getElementById(`${fullId}-type`);
            const gateSection = document.getElementById(`${fullId}-gate-section`);
            const inputsSection = document.getElementById(`${fullId}-inputs-section`);
            const probInput = document.getElementById(`${fullId}-prob`);
            const addChildButtonSection = document.getElementById(`${fullId}-add-child-section`);


            if (typeSelect.value === 'INTERMEDIATE') {
                gateSection.classList.remove('hidden');
                inputsSection.classList.remove('hidden');
                if(addChildButtonSection) addChildButtonSection.classList.remove('hidden');
                probInput.readOnly = true;
                probInput.classList.add('bg-gray-200');
                probInput.placeholder = "Calculada";
                probInput.value = ''; 
            } else { // BASIC
                gateSection.classList.add('hidden');
                inputsSection.classList.add('hidden');
                if(addChildButtonSection) addChildButtonSection.classList.add('hidden');
                probInput.readOnly = false;
                probInput.classList.remove('bg-gray-200');
                probInput.placeholder = "0-100";
            }
        }
        
        function renderFtaDiagram() {
            const topEventDescInput = document.getElementById('ftaTopEventDesc').value.trim();
            const topEventGateInput = document.getElementById('ftaTopEventGate').value;
            const topEventInputsStr = document.getElementById('ftaTopEventInputs').value.trim();

            const diagramContainer = document.getElementById('ftaDiagramContainer');
            diagramContainer.innerHTML = ''; 

            const elementsData = [];
            document.querySelectorAll('.fta-element-input-group').forEach(group => {
                const fullId = group.id; 
                const shortId = `N${fullId.split('-')[2]}`; 
                const description = group.querySelector('.fta-element-desc').value || `Elemento ${shortId}`;
                const probabilityStr = group.querySelector('.fta-element-prob').value;
                const type = group.querySelector('.fta-element-type').value;
                
                let probabilityForCalc = 0; 
                if (type === 'BASIC' && probabilityStr !== "") {
                    probabilityForCalc = parseFloat(probabilityStr) / 100.0; 
                    if (isNaN(probabilityForCalc) || probabilityForCalc < 0 || probabilityForCalc > 1) probabilityForCalc = 0;
                }

                let gate = null;
                let inputs = []; 
                if (type === 'INTERMEDIATE') {
                    gate = group.querySelector('.fta-element-gate').value;
                    inputs = group.querySelector('.fta-element-inputs').value.split(',')
                                 .map(s => s.trim().toUpperCase()) 
                                 .filter(s => s);
                }
                elementsData.push({ 
                    id: shortId, 
                    description, 
                    probabilityInput: probabilityStr, 
                    type, gate, inputs, 
                    calculatedProb: (type === 'BASIC' ? probabilityForCalc : undefined) 
                });
            });

            if (!topEventDescInput) {
                diagramContainer.innerHTML = '<p class="text-gray-400">Por favor, defina el Evento Principal (Top Event).</p>';
                return;
            }
            
            const nodesMap = new Map();
            const topEventNodeData = {
                id: 'TOP_EVENT_ID', 
                description: topEventDescInput,
                probabilityInput: "", 
                type: 'INTERMEDIATE', 
                gate: topEventGateInput,
                inputs: topEventInputsStr.split(',').map(s => s.trim().toUpperCase()).filter(s => s),
                children: [], 
                isTopEventNode: true, 
                rendered: false,
                calculatedProb: undefined
            };
            nodesMap.set(topEventNodeData.id, topEventNodeData);

            elementsData.forEach(el => {
                nodesMap.set(el.id, { ...el, children: [], isTopEventNode: false, rendered: false });
            });
            
            nodesMap.forEach(parentNode => {
                if (parentNode.inputs && parentNode.inputs.length > 0) {
                     parentNode.inputs.forEach(inputId => { 
                        let childNode = nodesMap.get(inputId);
                        if (!childNode) { 
                            childNode = {id: inputId, description: `ID: ${inputId} (No definido)`, probabilityInput: '', type: 'BASIC', children: [], rendered: false, calculatedProb: 0};
                            nodesMap.set(inputId, childNode); 
                        }
                        parentNode.children.push(childNode);
                    });
                }
            });

            function calculateNodeProbability(nodeId) {
                const node = nodesMap.get(nodeId);
                if (!node) return 0; 
                if (node.calculatedProb !== undefined && node.type !== 'BASIC') return node.calculatedProb; 
                if (node.type === 'BASIC') { 
                    let prob = 0; 
                    if (node.probabilityInput && node.probabilityInput !== "") {
                         prob = parseFloat(node.probabilityInput) / 100.0;
                         if (isNaN(prob) || prob < 0 || prob > 1) prob = 0; 
                    }
                    node.calculatedProb = prob; 
                    return node.calculatedProb;
                }

                if (node.type === 'INTERMEDIATE') {
                    if (!node.inputs || node.inputs.length === 0) {
                        node.calculatedProb = 0; 
                        return 0;
                    }
                    const childProbs = node.inputs.map(inputId => calculateNodeProbability(inputId));

                    if (node.gate === 'AND') {
                        node.calculatedProb = childProbs.reduce((acc, p) => acc * p, 1);
                    } else if (node.gate === 'OR') {
                        node.calculatedProb = 1 - childProbs.reduce((acc, p) => acc * (1 - p), 1);
                    } else {
                        node.calculatedProb = 0; 
                    }
                    return node.calculatedProb;
                }
                return 0; 
            }
            
            calculateNodeProbability(topEventNodeData.id);
            const topProbValue = nodesMap.get(topEventNodeData.id).calculatedProb;
            document.getElementById('ftaTopEventProb').value = topProbValue !== undefined ? (topProbValue * 100).toFixed(2) : '';


            function createFtaDiagramNodeRecursive(nodeData) {
                if (!nodeData || nodeData.rendered) return document.createDocumentFragment();
                nodeData.rendered = true;

                const nodeWrapper = document.createElement('div');
                nodeWrapper.className = 'fta-diagram-node';

                const eventBox = document.createElement('div');
                eventBox.classList.add('fta-event-box');
                if (nodeData.isTopEventNode) { 
                    eventBox.classList.add('fta-top-event-box');
                } else if (nodeData.type === 'INTERMEDIATE') {
                    eventBox.classList.add('fta-intermediate-event-box');
                } else { 
                    eventBox.classList.add('fta-basic-event-box');
                }
                
                let probDisplayValue = '';
                if (nodeData.calculatedProb !== undefined) { 
                    probDisplayValue = (nodeData.calculatedProb * 100).toFixed(2) + '%';
                } else if (nodeData.type === 'BASIC' && nodeData.probabilityInput) { 
                    probDisplayValue = nodeData.probabilityInput + '%';
                }


                eventBox.innerHTML = `<div class="description">${nodeData.description}</div><div class="percentage">${probDisplayValue}</div>`;
                nodeWrapper.appendChild(eventBox);

                if (nodeData.type === 'INTERMEDIATE' && nodeData.inputs.length > 0) {
                    eventBox.innerHTML += `<div class="fta-line-down"></div>`;
                    
                    const gateBox = document.createElement('div');
                    gateBox.classList.add('fta-gate-box', nodeData.gate === 'AND' ? 'fta-gate-and' : 'fta-gate-or');
                    gateBox.textContent = nodeData.gate;
                    nodeWrapper.appendChild(gateBox);
                    gateBox.innerHTML += `<div class="fta-line-down"></div>`;

                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'fta-node-children-container';
                    if (nodeData.inputs.length > 1) {
                        const bar = document.createElement('div');
                        bar.className = 'fta-children-horizontal-bar';
                        const childBoxWidth = 130; 
                        const gap = 10;
                        const barWidth = ((nodeData.inputs.length - 1) * (childBoxWidth + gap));
                        bar.style.width = `${Math.max(20, barWidth)}px`; 
                        bar.style.left = `calc(50% - ${barWidth / 2}px)`;
                        childrenContainer.appendChild(bar);
                    }

                    nodeData.inputs.forEach(inputId => {
                        const childNodeData = nodesMap.get(inputId);
                        const childElement = createFtaDiagramNodeRecursive(childNodeData); 
                        const childEventBox = childElement.querySelector('.fta-event-box');
                        if(childEventBox) childEventBox.innerHTML += `<div class="fta-line-up"></div>`;
                        childrenContainer.appendChild(childElement);
                    });
                    nodeWrapper.appendChild(childrenContainer);
                }
                return nodeWrapper;
            }
            
            nodesMap.forEach(n => n.rendered = false); 
            diagramContainer.appendChild(createFtaDiagramNodeRecursive(topEventNodeData));
            
            if (diagramContainer.children.length === 0) {
                 diagramContainer.innerHTML = '<p class="text-slate-400">No se pudo generar el diagrama. Verifique la definición del Top Event y los elementos.</p>';
            }

             if (document.getElementById('ftaDiagramVisualization')) {
                document.getElementById('ftaDiagramVisualization').scrollIntoView({ behavior: 'smooth' });
            }
        }


        let resetCallback = null;
        function confirmCurrentReset() {
            const modalTitle = document.getElementById('resetModalTitle');
            const modalMessage = document.getElementById('resetModalMessage');
            const confirmBtn = document.getElementById('confirmResetButton');

            if (activeTab === 'bowtie') {
                modalTitle.textContent = 'Confirmar Reinicio BowTie';
                modalMessage.textContent = '¿Estás seguro de que deseas borrar todos los datos del análisis BowTie? Esta acción no se puede deshacer.';
                resetCallback = executeResetBowTieAnalysis;
            } else if (activeTab === 'fta') {
                modalTitle.textContent = 'Confirmar Reinicio FTA';
                modalMessage.textContent = '¿Estás seguro de que deseas borrar todos los datos del Árbol de Fallos? Esta acción no se puede deshacer.';
                resetCallback = executeResetFtaAnalysis;
            }
            confirmBtn.onclick = () => {
                if (resetCallback) resetCallback();
                closeResetModal();
            };
            document.getElementById('resetConfirmationModal').classList.remove('hidden');
            document.getElementById('resetConfirmationModal').classList.add('modal-active');
        }

        function closeResetModal() {
            document.getElementById('resetConfirmationModal').classList.add('hidden');
            document.getElementById('resetConfirmationModal').classList.remove('modal-active');
            resetCallback = null;
        }

        function executeResetBowTieAnalysis() {
            document.getElementById('riskEvent').value = '';
            document.getElementById('causesContainer').innerHTML = '';
            document.getElementById('impactsContainer').innerHTML = '';
            document.getElementById('causesContainerForDiagram').innerHTML = '';
            document.getElementById('impactsContainerForDiagram').innerHTML = '';
            document.getElementById('eventBoxDiagram').textContent = 'EVENTO';
            causeCounter = 0;
            impactCounter = 0;
        }

        function executeResetFtaAnalysis() {
            document.getElementById('ftaTopEventDesc').value = '';
            document.getElementById('ftaTopEventProb').value = ''; 
            document.getElementById('ftaTopEventGate').value = 'OR';
            document.getElementById('ftaTopEventInputs').value = '';
            document.getElementById('ftaElementsContainer').innerHTML = '';
            document.getElementById('ftaDiagramContainer').innerHTML = '<p class="text-slate-400">El diagrama del FTA aparecerá aquí después de generar.</p>';
            ftaNodeCounter = 0;
        }
        
        function exportCurrentAnalysis() {
            if (activeTab === 'bowtie') {
                exportBowTieToXLSX();
            } else if (activeTab === 'fta') {
                exportFtaToXLSX();
            }
        }
        function handleCurrentFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval:""});
                
                if (activeTab === 'bowtie') {
                    executeResetBowTieAnalysis(); 
                    populateBowTieFromJSON(jsonData);
                } else if (activeTab === 'fta') {
                    executeResetFtaAnalysis();
                    populateFtaFromJSON(jsonData);
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = ''; 
        }

        function exportBowTieToXLSX() {
            const riskEvent = document.getElementById('riskEvent').value || "Evento no definido";
            let data = [[ "EventoRiesgo", riskEvent ]];
            document.querySelectorAll('.cause-input-group').forEach(group => {
                const causeName = group.querySelector('.cause-name-input').value;
                const barriers = Array.from(group.querySelectorAll('.preventive-barrier-input')).map(input => input.value);
                data.push(["Causa", causeName || "Causa sin nombre", ...barriers]);
            });
            data.push([]); 
            document.querySelectorAll('.impact-input-group').forEach(group => {
                const impactName = group.querySelector('.impact-name-input').value;
                const barriers = Array.from(group.querySelectorAll('.mitigative-barrier-input')).map(input => input.value);
                data.push(["Consecuencia", impactName || "Consecuencia sin nombre", ...barriers]);
            });
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "BowTie Analisis");
            XLSX.writeFile(workbook, "AnalisisBowTie.xlsx");
        }

        function populateBowTieFromJSON(jsonData) {
            if (jsonData.length === 0) return;
            const eventRow = jsonData.find(row => row[0] === "EventoRiesgo");
            if (eventRow && eventRow.length > 1) {
                document.getElementById('riskEvent').value = eventRow[1];
            }
            jsonData.forEach(row => {
                if (row.length < 2) return;
                const elementType = row[0];
                const elementName = row[1];
                const barriers = row.slice(2).filter(b => String(b).trim() !== "");
                if (elementType === "Causa") {
                    const causeDiv = addCauseInput();
                    if (causeDiv) {
                        causeDiv.querySelector('.cause-name-input').value = elementName;
                        const causeId = causeDiv.id;
                        barriers.forEach(barrierDesc => {
                            const barrierInput = addPreventiveBarrierInput(causeId);
                            if (barrierInput) barrierInput.value = barrierDesc;
                        });
                    }
                } else if (elementType === "Consecuencia") {
                    const impactDiv = addImpactInput();
                     if (impactDiv) {
                        impactDiv.querySelector('.impact-name-input').value = elementName;
                        const impactId = impactDiv.id;
                        barriers.forEach(barrierDesc => {
                            const barrierInput = addMitigativeBarrierInput(impactId);
                            if(barrierInput) barrierInput.value = barrierDesc;
                        });
                    }
                }
            });
            renderBowTieDiagram();
        }

        function exportFtaToXLSX() {
            const topEventDesc = document.getElementById('ftaTopEventDesc').value || "Top Event no definido";
            const topEventGate = document.getElementById('ftaTopEventGate').value || "OR";
            const topEventInputs = document.getElementById('ftaTopEventInputs').value || "";

            let data = [["FTATopEventDesc", topEventDesc], 
                        ["FTATopEventGate", topEventGate],
                        ["FTATopEventInputs", topEventInputs]];
            
            document.querySelectorAll('.fta-element-input-group').forEach(group => {
                const fullId = group.id;
                const shortId = `N${fullId.split('-')[2]}`;
                const description = group.querySelector('.fta-element-desc').value;
                const type = group.querySelector('.fta-element-type').value;
                let probability = ''; 
                let gate = '';
                let inputs = '';
                if (type === 'BASIC') {
                    probability = group.querySelector('.fta-element-prob').value;
                } else if (type === 'INTERMEDIATE') {
                    gate = group.querySelector('.fta-element-gate').value;
                    inputs = group.querySelector('.fta-element-inputs').value;
                }
                data.push([shortId, description, probability, type, gate, inputs]);
            });
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "FTA Analisis");
            XLSX.writeFile(workbook, "AnalisisFTA.xlsx");
        }

        function populateFtaFromJSON(jsonData) {
            if (jsonData.length === 0) return;
            
            const findRowValue = (key) => {
                const row = jsonData.find(r => r[0] === key);
                return row && row.length > 1 ? row[1] : "";
            };

            document.getElementById('ftaTopEventDesc').value = findRowValue("FTATopEventDesc");
            document.getElementById('ftaTopEventGate').value = findRowValue("FTATopEventGate") || "OR";
            document.getElementById('ftaTopEventInputs').value = findRowValue("FTATopEventInputs");

            jsonData.forEach(row => {
                if (["FTATopEventDesc", "FTATopEventProb", "FTATopEventGate", "FTATopEventInputs"].includes(row[0]) || row.length < 4) return; 
                
                const shortIdFromFile = row[0]; 
                const description = row[1];
                const probability = row[2]; 
                const type = row[3];
                const gate = row[4] || 'OR'; 
                const inputs = row[5] || '';

                addFtaElementInput(); 
                const newElementGroup = document.getElementById(`fta-node-${ftaNodeCounter}`); 
                if (newElementGroup) {
                    newElementGroup.querySelector('.fta-element-desc').value = description;
                    const typeSelect = newElementGroup.querySelector('.fta-element-type');
                    typeSelect.value = type;
                    toggleFtaGateInput(`fta-node-${ftaNodeCounter}`); 
                    
                    if (type === 'BASIC') {
                         newElementGroup.querySelector('.fta-element-prob').value = probability;
                    } else if (type === 'INTERMEDIATE') {
                        newElementGroup.querySelector('.fta-element-gate').value = gate;
                        newElementGroup.querySelector('.fta-element-inputs').value = inputs;
                        newElementGroup.querySelector('.fta-element-prob').value = ''; 
                    }
                }
            });
            renderFtaDiagram();
        }

        function generateCurrentDiagram() {
            if (activeTab === 'bowtie') {
                renderBowTieDiagram();
            } else if (activeTab === 'fta') {
                renderFtaDiagram();
            }
        }
    </script>
</body>
</html>
